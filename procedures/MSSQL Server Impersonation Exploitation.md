---
id: 8d9bd27a-39c8-4a35-8381-97735b1cbba8
name: MSSQL Server Impersonation Exploitation
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:20.657050+00:00'
updated_at: '2023-04-10T20:36:41.349341+00:00'
tactics:
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
- '[[Initial Access|TA0001 - Initial Access]]'
- '[[Persistence|TA0003 - Persistence]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Access Token Manipulation|T1134 - Access Token Manipulation]]'
- '[[Valid Accounts|T1078 - Valid Accounts]]'
tags:
- '[[Audit Checks]]'
- '[[Find and exploit impersonation opportunities]]'
- '[[MSSQL Server]]'
commands:
- '[[Check if user is a member of db_owner role]]'
- '[[Check if user is a member of sysadmin role]]'
- '[[Execute as dbo user]]'
---

# MSSQL Server Impersonation Exploitation

## Summary

MSSQL Server Impersonation Exploitation is a technique used by attackers to gain access to sensitive data stored in an MSSQL database. By exploiting impersonation opportunities, attackers can elevate their privileges and access data that they would not normally have access to. This technique can be

## Description

# Description

MSSQL Server Impersonation Exploitation is a technique used by attackers to gain access to sensitive data stored in an MSSQL database. By exploiting impersonation opportunities, attackers can elevate their privileges and access data that they would not normally have access to. This technique can be used to steal sensitive information, such as credit card numbers, social security numbers, and other personally identifiable information (PII).

To exploit impersonation opportunities, attackers typically use a combination of social engineering and technical skills. They may use phishing emails to gain access to user credentials, or they may use other techniques to obtain privileged access to the MSSQL Server. Once they have access, they can use SQL Server Audit Privilege Impersonation or other techniques to elevate their privileges and gain access to sensitive data.

The business value of this procedure is to identify and mitigate impersonation opportunities in order to protect sensitive data from unauthorized access.

 

## Requirements

1. Access to the target MSSQL Server

1. Valid credentials with sufficient privileges

1. Knowledge of SQL Server Audit Privilege Impersonation

 

## Defense

1. Implement strong authentication mechanisms to prevent unauthorized access to the MSSQL Server

1. Monitor MSSQL Server logs for suspicious activity, such as failed login attempts or unusual privilege escalations

1. Regularly review and update MSSQL Server permissions to ensure that only authorized users have access to sensitive data

 

## Objectives

1. Identify potential impersonation opportunities in the MSSQL Server

1. Exploit identified impersonation opportunities to elevate privileges

1. Access sensitive data stored in the MSSQL Server

 

# Instructions

1. To check if the current user has DB_OWNER role and impersonate dbo, use the following commands:
1. `select is_member('db_owner');` - This command will check if the current user has DB_OWNER role.
2. `execute as user = 'dbo'` - This command will impersonate the dbo user.
3. `SELECT is_srvrolemember('sysadmin')` - This command will check if the current user has sysadmin role.

 



**Code**: [[SQL> select is_member('db_owner');
SQL> execute as]]



> The DB_OWNER role is a database-level role that allows a user to perform any activity in the database. The `execute as user` command allows a user to impersonate another user, in this case, dbo. The `is_srvrolemember` function checks whether the current user is a member of the specified server-level role, in this case, sysadmin.



**Command** ([[Check if user is a member of db_owner role]]):

```bash
select is_member('db_owner');
```





**Command** ([[Execute as dbo user]]):

```bash
execute as user = 'dbo'
```





**Command** ([[Check if user is a member of sysadmin role]]):

```bash
SELECT is_srvrolemember('sysadmin')
```



2. This command is used to impersonate the 'sa' account in SQL Server and check if it has the 'sysadmin' role. The command requires the following arguments:
- Username: The username of the account to impersonate (in this case, 'sa').
- Password: The password for the account to impersonate.
- Instance: The name of the SQL Server instance to connect to.

Once the command is executed, it will impersonate the 'sa' account and run a query to check if it has the 'sysadmin' role.

 



**Code**: [[Invoke-SQLAuditPrivImpersonateLogin -Username sa -]]



> This command can be useful for testing the security of a SQL Server instance, as it allows you to see if an attacker could potentially gain administrative access by exploiting the 'sa' account. It can also be used for auditing purposes, to check if the 'sa' account has been misused or compromised.

## MITRE ATT&CK Mapping

### Tactics

- [[Defense Evasion|TA0005 - Defense Evasion]]
- [[Initial Access|TA0001 - Initial Access]]
- [[Persistence|TA0003 - Persistence]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Access Token Manipulation|T1134 - Access Token Manipulation]]
- [[Valid Accounts|T1078 - Valid Accounts]]

## Commands Used

- [[Check if user is a member of db_owner role]]
- [[Check if user is a member of sysadmin role]]
- [[Execute as dbo user]]

## Tags

- [[Audit Checks]]
- [[Find and exploit impersonation opportunities]]
- [[MSSQL Server]]


