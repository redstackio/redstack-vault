---
id: 37609d52-3869-4abc-afb6-a84dc1ffde22
name: Checksum Validation Exploitation for Active Directory
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:02.632736+00:00'
updated_at: '2023-04-10T20:36:13.609198+00:00'
tactics:
- '[[Credential Access|TA0006 - Credential Access]]'
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
techniques:
- '[[Credential Dumping|T1003 - Credential Dumping]]'
- '[[DCShadow|T1207 - DCShadow]]'
- '[[Exploitation for Credential Access|T1212 - Exploitation for Credential Access]]'
tags:
- '[[Active Directory Attacks]]'
- '[[From CVE to SYSTEM shell on DC]]'
- '[[MS14-068 Checksum Validation]]'
commands:
- '[[Convert Name to SID]]'
- '[[Get User Accounts]]'
- '[[Kerberos Checksum]]'
- '[[Lookup user SID]]'
---

# Checksum Validation Exploitation for Active Directory

## Summary

Checksum validation is a vulnerability that allows attackers to elevate privileges and gain access to sensitive information in an Active Directory environment. This procedure involves using various tools such as Kekeo, Metasploit, and Mimikatz to exploit this vulnerability and gain SYSTEM shell acc

## Description

# Description

Checksum validation is a vulnerability that allows attackers to elevate privileges and gain access to sensitive information in an Active Directory environment. This procedure involves using various tools such as Kekeo, Metasploit, and Mimikatz to exploit this vulnerability and gain SYSTEM shell access on a domain controller. The attacker can then dump credentials and move laterally throughout the network. This attack can be devastating for organizations as it can lead to complete compromise of the Active Directory environment.

 

## Requirements

1. Valid domain credentials

1. Access to the domain controller

1. Tools such as Kekeo, Metasploit, and Mimikatz

 

## Defense

1. Ensure that all systems and software are up-to-date with the latest patches and updates

1. Implement multi-factor authentication for all user accounts

1. Monitor network traffic and logs for suspicious activity

 

## Objectives

1. Gain SYSTEM shell access on a domain controller

1. Dump credentials

1. Move laterally throughout the network

 

# Instructions

1. To lookup the SID of a user by their username, use the 'lookupnames' command followed by the username. For example, to lookup the SID of the user 'john.smith', run the following command:
rpcclient $> lookupnames john.smith

 



**Code**: [[rpcclient $> lookupnames john.smith
john.smith S-1]]



> The 'lookupnames' command is used to retrieve the SID of a user by their username. This can be useful in scenarios where you need to verify the identity of a user or check their permissions. The command returns the username and corresponding SID in the format 'username SID (User: x)', where 'x' is the numeric identifier of the user. Note that the command must be run with administrative privileges.



**Command** ([[Lookup user SID]]):

```bash
rpcclient $> lookupnames john.smith
```



2. Open a PowerShell window and run the following command: wmic useraccount get name,sid

 



**Code**: [[wmic useraccount get name,sid
Administrator  S-1-5]]



> This command retrieves a list of all user accounts on the system along with their corresponding Security IDs (SIDs). The SID is a unique identifier for each user account that is used by Windows to control access to resources. The output of the command will display the name of each user account followed by its corresponding SID. This information can be useful for troubleshooting permission issues or for auditing purposes.



**Command** ([[Get User Accounts]]):

```bash
wmic useraccount get name,sid
Administrator  S-1-5-21-3415849876-833628785-5197346142-500   
Guest          S-1-5-21-3415849876-833628785-5197346142-501   
Administrator  S-1-5-21-297520375-2634728305-5197346142-500   
Guest          S-1-5-21-297520375-2634728305-5197346142-501   
krbtgt         S-1-5-21-297520375-2634728305-5197346142-502   
lambda         S-1-5-21-297520375-2634728305-5197346142-1110
```



3. This command is used to convert a given name to its corresponding security identifier (SID).

 



**Code**: [[Convert-NameToSid high-sec-corp.localkrbtgt
S-1-5-]]



> The 'high-sec-corp.localkrbtgt' argument in the command represents the name that needs to be converted to its corresponding SID. The output of the command 'S-1-5-21-2941561648-383941485-1389968811-502' represents the SID of the given name. This command can be useful in scenarios where you need to identify the SID of a particular user or group in order to grant permissions or access to resources.



**Command** ([[Convert Name to SID]]):

```bash
Convert-NameToSid high-sec-corp.localkrbtgt
S-1-5-21-2941561648-383941485-1389968811-502
```



4. To exploit the MS14-068 vulnerability using Kekeo, run the following command:

 



**Code**: [[Doc: https://github.com/gentilkiwi/kekeo/wiki/ms14]]



> The Kekeo tool is used to exploit the MS14-068 vulnerability in Windows Active Directory. The command provided in the instruction field generates a forged Kerberos ticket that can be used to elevate privileges on a target domain controller. The 'ms14068' argument in the data field refers to the specific vulnerability being exploited. It is important to note that this exploit should only be used for authorized penetration testing and not for malicious purposes.

5. To generate a ticket with Metasploit, use the 'ticket' command followed by the ticket type and any necessary arguments. The available ticket types are 'kerberos', 'smb', and 'web_delivery'. For example, to generate a Kerberos ticket, use the command 'ticket kerberos'.

 



**Code**: [[metasploit]]



> The 'ticket' command in Metasploit is used to generate various types of tickets that can be used to gain access to resources on a target system. The 'kerberos' ticket type is used to generate a Kerberos ticket that can be used to authenticate to a Windows domain. The 'smb' ticket type is used to generate a ticket that can be used to authenticate to an SMB server. The 'web_delivery' ticket type is used to generate a ticket that can be used to authenticate to a web server.

6. Use pykek to separate text using the 'or' delimiter.

 



**Code**: [[pykek]]



> The 'pykek' command takes a string of text and separates it into multiple options using the 'or' delimiter. For example, if the input text is 'apple or banana or orange', the output will be ['apple', 'banana', 'orange']. This can be useful for creating lists or options in programming or writing.

7. The ms14_068_kerberos_checksum module in Metasploit framework is used to exploit the Kerberos Checksum vulnerability in Microsoft Windows. This module requires the following arguments to be set:
DOMAIN - The target domain in uppercase.
PASSWORD - The password of the domain user.
RHOSTS - The target IP address range or CIDR identifier.
RPORT - The target port.
Timeout - The TCP timeout to establish connection and read data.
USER - The domain user.
USER_SID - The SID of the domain user.

 



**Code**: [[Metasploit: auxiliary/admin/kerberos/ms14_068_kerb]]



> This module exploits the Kerberos Checksum vulnerability in Microsoft Windows. By exploiting this vulnerability, an attacker can elevate their privileges to Domain Administrator. The module requires valid domain user credentials to exploit this vulnerability. The vulnerability exists in the implementation of Kerberos in Microsoft Windows and can be exploited by sending a specially crafted Kerberos message to the target system. Successful exploitation of this vulnerability allows the attacker to generate a valid Kerberos ticket for any user in the domain, including domain administrators.



**Command** ([[Kerberos Checksum]]):

```bash
DOMAIN    LABDOMAIN.LOCAL
PASSWORD  P@ssw0rd
RHOSTS    10.10.10.10
RPORT     88
Timeout   10
USER      lambda
USER_SID  S-1-5-21-297520375-2634728305-5197346142-1106
```



8. To use this exploit, follow these steps:
1. Clone the repository from https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek
2. Run the command with the required parameters:
   -u: The username with administrative privileges
   -p: The clear-text password for the user
   -s: The SID of the user
   -d: The IP address or hostname of the domain controller
3. Wait for the exploit to complete and the ccache file to be created.

 



**Code**: [[# Alternative download: https://github.com/SecWiki]]



> This exploit is used to exploit the MS14-068 vulnerability in Windows Kerberos. It allows an attacker to elevate their privileges and gain access to sensitive information on the domain controller. The command requires the username with administrative privileges, the clear-text password for the user, the SID of the user, and the IP address or hostname of the domain controller. The exploit will create a ccache file that can be used to authenticate as the compromised user.

9. mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords full" exit

 



**Code**: [[mimikatz]]



> This command will run Mimikatz, a tool used for extracting Windows credentials such as passwords, hashes, and Kerberos tickets. The command will first enable debug privileges, then execute the sekurlsa module with the logonpasswords option set to full, which will dump all available credentials. Finally, the command will exit Mimikatz.

10. To extract a Kerberos TGT using Mimikatz, run the following command:

 



**Code**: [[mimikatz.exe "kerberos::ptc c:\temp\TGT_darthsidio]]



> The 'mimikatz.exe' command is used to run Mimikatz, a post-exploitation tool that can be used to extract credentials from a Windows system. The 'kerberos::ptc' command is used to extract a Kerberos TGT from a Credential Cache (ccache) file. In this case, the TGT is being extracted from the 'TGT_darthsidious@lab.adsecurity.org.ccache' file located in the 'c:\temp\' directory. This command can be used by attackers to extract credentials from compromised systems.

## MITRE ATT&CK Mapping

### Tactics

- [[Credential Access|TA0006 - Credential Access]]
- [[Defense Evasion|TA0005 - Defense Evasion]]

### Techniques

- [[Credential Dumping|T1003 - Credential Dumping]]
- [[DCShadow|T1207 - DCShadow]]
- [[Exploitation for Credential Access|T1212 - Exploitation for Credential Access]]

## Commands Used

- [[Convert Name to SID]]
- [[Get User Accounts]]
- [[Kerberos Checksum]]
- [[Lookup user SID]]

## Tags

- [[Active Directory Attacks]]
- [[From CVE to SYSTEM shell on DC]]
- [[MS14-068 Checksum Validation]]


