---
id: 5157f8b9-aaa1-415e-a50e-118834d4b9ab
name: PrintNightmare - Exploiting CVE to gain SYSTEM shell on DC via Anonymous SMB
  Server
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:02.903450+00:00'
updated_at: '2023-04-10T20:25:42.614659+00:00'
tactics:
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
- '[[Execution|TA0002 - Execution]]'
- '[[Initial Access|TA0001 - Initial Access]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[DCShadow|T1207 - DCShadow]]'
- '[[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]'
- '[[Exploit Public-Facing Application|T1190 - Exploit Public-Facing Application]]'
- '[[Service Execution|T1035 - Service Execution]]'
tags:
- '[[Active Directory Attacks]]'
- '[[From CVE to SYSTEM shell on DC]]'
- '[[PrintNightmare]]'
commands:
- '[[Enable Anonymous SMB Server]]'
---

# PrintNightmare - Exploiting CVE to gain SYSTEM shell on DC via Anonymous SMB Server

## Summary

PrintNightmare is a vulnerability in the Windows Print Spooler service that allows an attacker to execute arbitrary code with SYSTEM privileges on a domain controller (DC). This procedure demonstrates how to exploit PrintNightmare by enabling an Anonymous SMB Server and using it to upload a malicio

## Description

# Description

PrintNightmare is a vulnerability in the Windows Print Spooler service that allows an attacker to execute arbitrary code with SYSTEM privileges on a domain controller (DC). This procedure demonstrates how to exploit PrintNightmare by enabling an Anonymous SMB Server and using it to upload a malicious DLL file to the DC. Once the DLL file is uploaded, the attacker can use it to execute commands with SYSTEM privileges.

From an offensive perspective, this procedure allows an attacker to gain full control over the domain and all its assets. The technical explanation involves exploiting a vulnerability in the Windows Print Spooler service by uploading a malicious DLL file to a DC via an Anonymous SMB Server. The business value of this procedure is to demonstrate the importance of timely patching and vulnerability management, as well as the need for network segmentation and privileged access management.

 

## Requirements

1. Domain user account with administrative privileges

1. Access to a domain controller

1. Ability to enable Anonymous SMB Server

1. Ability to upload a file to the DC

 

## Defense

1. Disable the Windows Print Spooler service on all non-print servers

1. Implement network segmentation to limit lateral movement

1. Enforce the principle of least privilege to limit the impact of a compromised account

 

## Objectives

1. Gain SYSTEM shell on a domain controller

1. Demonstrate the impact and severity of the PrintNightmare vulnerability

1. Highlight the importance of timely patching and vulnerability management

1. Emphasize the need for network segmentation and privileged access management

 

# Instructions

1. To enable anonymous SMB server, run the following command:

 



**Code**: [[Import-Module .\Invoke-BuildAnonymousSMBServer.ps1]]



> This command imports a PowerShell module called Invoke-BuildAnonymousSMBServer and uses it to enable anonymous SMB server mode on the specified path. The -Path parameter specifies the path to the shared folder that you want to enable anonymous access to. The -Mode parameter specifies whether you want to enable or disable anonymous access. In this case, we are enabling anonymous access by setting the -Mode parameter to 'Enable'.



**Command** ([[Enable Anonymous SMB Server]]):

```bash
Import-Module .\Invoke-BuildAnonymousSMBServer.ps1; Invoke-BuildAnonymousSMBServer -Path C:\Share -Mode Enable
```



## MITRE ATT&CK Mapping

### Tactics

- [[Defense Evasion|TA0005 - Defense Evasion]]
- [[Execution|TA0002 - Execution]]
- [[Initial Access|TA0001 - Initial Access]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[DCShadow|T1207 - DCShadow]]
- [[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]
- [[Exploit Public-Facing Application|T1190 - Exploit Public-Facing Application]]
- [[Service Execution|T1035 - Service Execution]]

## Commands Used

- [[Enable Anonymous SMB Server]]

## Tags

- [[Active Directory Attacks]]
- [[From CVE to SYSTEM shell on DC]]
- [[PrintNightmare]]


