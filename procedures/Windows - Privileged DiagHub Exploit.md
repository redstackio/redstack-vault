---
id: f0e871fe-b849-403a-8516-d8c81b00c838
name: Windows - Privileged DiagHub Exploit
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:30.324849+00:00'
updated_at: '2023-04-10T20:37:43.452421+00:00'
tactics:
- '[[Command and Control|TA0011 - Command and Control]]'
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
- '[[Execution|TA0002 - Execution]]'
- '[[Lateral Movement|TA0008 - Lateral Movement]]'
- '[[Persistence|TA0003 - Persistence]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Process Injection|T1055 - Process Injection]]'
- '[[Remote File Copy|T1105 - Remote File Copy]]'
- '[[Scheduled Task|T1053 - Scheduled Task]]'
tags:
- '[[DiagHub]]'
- '[[EoP - Privileged File Write]]'
- '[[Exploit]]'
- '[[Windows - Privilege Escalation]]'
---

# Windows - Privileged DiagHub Exploit

## Summary

This procedure involves exploiting the DiagHub service in Windows to escalate privileges on the target system. An attacker can use this technique to gain access to sensitive information and execute commands with elevated privileges. The attack involves creating a scheduled task that copies a malici

## Description

# Description

This procedure involves exploiting the DiagHub service in Windows to escalate privileges on the target system. An attacker can use this technique to gain access to sensitive information and execute commands with elevated privileges. The attack involves creating a scheduled task that copies a malicious DLL to a system directory, which is then loaded by the DiagHub service. This DLL can then execute code with SYSTEM privileges, allowing the attacker to perform further actions on the compromised system.

Technical Explanation: This attack relies on the DiagHub service, which is a legitimate Windows service used for diagnostics. The attacker creates a scheduled task that runs a command to copy a malicious DLL to a system directory. The scheduled task is configured to run with SYSTEM privileges, which allows the attacker to copy the DLL to a protected directory. The DLL is then loaded by the DiagHub service, which executes the code within the DLL with SYSTEM privileges. This allows the attacker to perform actions with elevated privileges on the compromised system.

Business Value: This procedure can be used by an attacker to gain access to sensitive information and execute commands with elevated privileges. This can lead to data theft, system compromise, and financial loss for the targeted organization.

 

## Requirements

1. Access to a low-privileged user account on the target system

1. Ability to create a scheduled task

1. Ability to copy files to a system directory

 

## Defense

1. Restrict access to the DiagHub service to only authorized users

1. Monitor for suspicious scheduled tasks and file copies

1. Limit user privileges to prevent the creation of scheduled tasks and file copies

 

## Objectives

1. Gain SYSTEM-level privileges on the target system

1. Execute commands with elevated privileges

 

# Instructions

1. To start the reverse shell listener, run the following command in your terminal: nc.exe -lvp <port_number> -e cmd.exe

 



**Code**: [[C:\Windows\System32\spool\drivers\color\nc.exe -lv]]



> -l: listen mode
-v: verbose mode
-p: specify the port number to listen on
-e: specify the program to execute after a connection is established
<port_number>: the port number to listen on. This should match the port number used in the payload on the target machine.

## MITRE ATT&CK Mapping

### Tactics

- [[Command and Control|TA0011 - Command and Control]]
- [[Defense Evasion|TA0005 - Defense Evasion]]
- [[Execution|TA0002 - Execution]]
- [[Lateral Movement|TA0008 - Lateral Movement]]
- [[Persistence|TA0003 - Persistence]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Process Injection|T1055 - Process Injection]]
- [[Remote File Copy|T1105 - Remote File Copy]]
- [[Scheduled Task|T1053 - Scheduled Task]]

## Tags

- [[DiagHub]]
- [[EoP - Privileged File Write]]
- [[Exploit]]
- [[Windows - Privilege Escalation]]


