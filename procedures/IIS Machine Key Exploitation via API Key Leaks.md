---
id: f64c6cf9-a760-4f61-86f3-78ce1097aa2a
name: IIS Machine Key Exploitation via API Key Leaks
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:55:53.384147+00:00'
updated_at: '2023-04-06T03:55:53.398629+00:00'
tactics:
- '[[Credential Access|TA0006 - Credential Access]]'
techniques:
- '[[Unsecured Credentials|T1552 - Unsecured Credentials]]'
sub_techniques:
- '[[Credentials in Registry|T1552.002 - Credentials in Registry]]'
tags:
- '[[API Key Leaks]]'
- '[[Exploit]]'
- '[[Identify known machine key]]'
- '[[IIS Machine Keys]]'
commands:
- '[[AspDotNetWrapper Decode MAC]]'
- '[[ViewGen Guess]]'
---

# IIS Machine Key Exploitation via API Key Leaks

## Summary

IIS Machine Key is a cryptographic element that is used for encrypting and decrypting data in ASP.NET applications. If an attacker is able to access the machine key file, it can lead to complete compromise of the web application. This procedure explains how to identify known machine keys and use th

## Description

# Description

IIS Machine Key is a cryptographic element that is used for encrypting and decrypting data in ASP.NET applications. If an attacker is able to access the machine key file, it can lead to complete compromise of the web application. This procedure explains how to identify known machine keys and use them to exploit a web application that has an API key leak vulnerability. By using the identified machine key, an attacker can decrypt the encrypted data, such as cookies or ViewState, and gain access to sensitive information.

## Requirements

1. Access to a web application that has an API key leak vulnerability

1. Access to the machine key file

## Defense

1. Secure the machine key file by restricting access to only authorized personnel.

1. Implement secure coding practices to prevent API key leaks and protect sensitive information.

1. Monitor network traffic for any suspicious activity, such as unauthorized access to the machine key file.

## Objectives

1. Identify known machine keys for the target web application

1. Exploit the identified machine key to decrypt sensitive information

# Instructions

1. Run the above command to identify the known machine key for the target web application.

**Code**: [[# --webconfig WEBCONFIG: automatically load keys a]]

> This command identifies the known machine key for the target web application by decrypting the ViewState parameter value. The ViewState parameter value is obtained by intercepting the HTTP request and response using a proxy tool like Burp Suite. The identified machine key can be used to decrypt sensitive information.

**Command** ([[ViewGen Guess]]):

```bash
viewgen --guess "/wEPDwUKMTYyODkyNTEzMw9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkuVmqYhhtcnJl6Nfet5ERqNHMADI="
```

**Command** ([[AspDotNetWrapper Decode MAC]]):

```bash
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata <real viewstate value> --purpose=viewstate --modifier=<modifier value> â€“macdecode
```

## MITRE ATT&CK Mapping

### Tactics

- [[Credential Access|TA0006 - Credential Access]]

### Techniques

- [[Unsecured Credentials|T1552 - Unsecured Credentials]]

### Sub-Techniques

- [[Credentials in Registry|T1552.002 - Credentials in Registry]]

## Commands Used

- [[AspDotNetWrapper Decode MAC]]
- [[ViewGen Guess]]

## Tags

- [[API Key Leaks]]
- [[Exploit]]
- [[Identify known machine key]]
- [[IIS Machine Keys]]
