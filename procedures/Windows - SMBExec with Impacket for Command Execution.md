---
id: d7943250-fd0a-4f3f-bf5d-e1de4cd25c8f
name: Windows - SMBExec with Impacket for Command Execution
type: procedure
verified: false
submitted: false
created_at: '2023-04-06T03:56:30.998840+00:00'
updated_at: '2023-04-10T20:38:05.010016+00:00'
tactics:
- '[[Lateral Movement|TA0008 - Lateral Movement]]'
techniques:
- '[[Remote Services|T1021 - Remote Services]]'
sub_techniques:
- '[[SMB/Windows Admin Shares|T1021.002 - SMB/Windows Admin Shares]]'
- '[[Windows Remote Management|T1021.006 - Windows Remote Management]]'
tags:
- '[[Impacket]]'
- '[[SMBExec]]'
- '[[Windows - Using credentials]]'
commands:
- '[[Get Command Prompt Path]]'
- '[[Open Command Prompt]]'
- '[[Set up variables]]'
---

# Windows - SMBExec with Impacket for Command Execution

## Summary

This procedure uses Impacket and SMBExec to execute commands on a remote Windows machine using valid credentials. This technique can be used to move laterally within a network, escalate privileges, or gather information. Impacket is a collection of Python classes for working with network protocols 

## Description

# Description

This procedure uses Impacket and SMBExec to execute commands on a remote Windows machine using valid credentials. This technique can be used to move laterally within a network, escalate privileges, or gather information. Impacket is a collection of Python classes for working with network protocols and SMBExec is a tool within Impacket that allows for remote command execution on Windows systems. By providing valid credentials, an attacker can execute commands on a remote machine as if they were physically present at the machine. This technique can be used to perform actions such as creating a new service, executing batch files, and listing directories.

 

## Requirements

1. Valid credentials with permissions to execute commands on the target machine

1. Network access to the target machine

1. Impacket and SMBExec installed on the attacker's machine

 

## Defense

1. Ensure that all credentials used are strong and complex

1. Implement network segmentation to limit lateral movement within the network

1. Monitor for unusual command execution and network traffic

 

## Objectives

1. Execute commands on a remote Windows machine

1. Move laterally within a network

1. Escalate privileges

1. Gather information

 

# Instructions

1. To create a service, use the following command:
create-service <service-name>

 



**Code**: [[BTOBTO]]



> This command creates a new service with the specified name. The service name must be unique and cannot already exist in the system. Once created, the service can be configured and deployed to a production environment.

2. This command allows the attacker to execute multiple commands by creating a batch file with the specified commands and executing it on the target system. The batch file can be created and transferred to the target system using various techniques such as file transfer protocols or social engineering.

 



**Code**: [[%TEMP/execute.bat]]



> The 'data' field specifies the location and name of the batch file to be created on the target system. The 'text' field provides additional information about the purpose of the command. The 'instruction' field explains how to use this command and what it does. The 'explain' field can be used to provide detailed information about the arguments that can be used with this command.

3. This command is used to execute batch files. The command takes in the following arguments:
- OUTPUT_FILENAME: The name of the output file generated by the batch file.
- BATCH_FILENAME: The name of the batch file to be executed.
- SMBSERVER_DIR: The directory where the batch file is located.
- DUMMY_SHARE: A dummy share name used to access the SMBSERVER_DIR.
- SERVICE_NAME: The name of the service to be executed.

Example:
execute.bat --OUTPUT_FILENAME=output.txt --BATCH_FILENAME=batch_file.bat --SMBSERVER_DIR=/path/to/batch_file --DUMMY_SHARE=TMP --SERVICE_NAME=BTOBTO

 



**Code**: [[OUTPUT_FILENAME = '__output'
BATCH_FILENAME  = 'ex]]



> The 'execute.bat' command is used to execute batch files. It takes in several arguments that are used to specify the details of the batch file and the execution process. The 'OUTPUT_FILENAME' argument specifies the name of the output file generated by the batch file. The 'BATCH_FILENAME' argument specifies the name of the batch file to be executed. The 'SMBSERVER_DIR' argument specifies the directory where the batch file is located. The 'DUMMY_SHARE' argument is a dummy share name used to access the SMBSERVER_DIR. Finally, the 'SERVICE_NAME' argument specifies the name of the service to be executed.

To use this command, simply provide the required arguments in the format shown in the example above.



**Command** ([[Set up variables]]):

```bash
OUTPUT_FILENAME = '__output'
BATCH_FILENAME  = 'execute.bat'
SMBSERVER_DIR   = '__tmp'
DUMMY_SHARE     = 'TMP'
SERVICE_NAME    = 'BTOBTO'
```



4. This command is used to list the contents of a directory. The output is stored in a file named '__output' located in the root directory of the C drive. To execute this command, copy and paste the above command in the command prompt.

 



**Code**: [[%COMSPEC% /Q /c echo dir &gt; \\127.0.0.1\C$\__out]]



> The command starts by echoing the 'dir' command to the '__output' file. The '2&gt;&amp;1' redirects the standard error stream to the standard output stream. The output is then redirected to a batch file named 'execute.bat' located in the TEMP directory. Finally, the batch file is executed and then deleted.

5. Open the Windows Command Prompt and type %COMSPEC%

 



**Code**: [[%COMSPEC%]]



> This command will display the file path of the Windows Command Prompt executable file on your computer.



**Command** ([[Get Command Prompt Path]]):

```bash
%COMSPEC%
```



6. Open the Command Prompt by pressing the Windows key + R and typing 'cmd' or by searching for 'cmd' in the Start menu.

 



**Code**: [[C:\WINDOWS\system32\cmd.exe]]



> The Command Prompt is a command line interface used to execute commands and run scripts on Windows operating systems. The path specified in the data field points to the location of the cmd.exe executable file on the system. This file is the main executable for the Command Prompt and is responsible for executing commands entered by the user.



**Command** ([[Open Command Prompt]]):

```bash
C:\WINDOWS\system32\cmd.exe
```



7. This command creates a remote shell to execute commands on a remote machine.

To use this command, you need to provide the following arguments:
1. share: The name of the share to use.
2. rpc: The IP address of the remote machine.
3. mode: The mode to use (either 'SMB' or 'RPC').
4. serviceName: The name of the service to use.
5. shell_type: The type of shell to use (either 'cmd' or 'powershell').

Once you have provided the required arguments, you can execute commands on the remote machine using the created shell.

 



**Code**: [[class RemoteShell(cmd.Cmd):
    def __init__(self,]]



> The RemoteShell command creates a remote shell to execute commands on a remote machine. It takes in the required arguments of share, rpc, mode, serviceName, and shell_type. The share argument is the name of the share to use, rpc is the IP address of the remote machine, mode is the mode to use (either SMB or RPC), serviceName is the name of the service to use, and shell_type is the type of shell to use (either cmd or powershell).

Once the required arguments are provided, you can execute commands on the remote machine using the created shell. This command is useful for remotely executing commands on a machine without the need for physical access to the machine.

## MITRE ATT&CK Mapping

### Tactics

- [[Lateral Movement|TA0008 - Lateral Movement]]

### Techniques

- [[Remote Services|T1021 - Remote Services]]

### Sub-Techniques

- [[SMB/Windows Admin Shares|T1021.002 - SMB/Windows Admin Shares]]
- [[Windows Remote Management|T1021.006 - Windows Remote Management]]

## Commands Used

- [[Get Command Prompt Path]]
- [[Open Command Prompt]]
- [[Set up variables]]

## Tags

- [[Impacket]]
- [[SMBExec]]
- [[Windows - Using credentials]]


